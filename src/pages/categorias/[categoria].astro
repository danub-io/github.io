---
import Base from "@/layouts/Base.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import { getTaxonomy } from "@/lib/taxonomyParser.astro";
import taxonomyFilter from "@/lib/utils/taxonomyFilter";
import { humanize, slugify } from "@/lib/utils/textConverter";
import dateFormat from "@/lib/utils/dateFormat";
import { Image } from "astro:assets";
import placeholder from "@/assets/images/placeholder.png";

export async function getStaticPaths() {
  const categories = await getTaxonomy("posts", "categories");
  return categories.map((category) => ({
    params: { categoria: slugify(category) },
  }));
}

const { categoria } = Astro.params;
const posts = await getSinglePage("posts");
const filterByCategories = taxonomyFilter(posts, "categories", categoria!);
---

<Base title={`Tema: ${humanize(categoria!)}`}>
  <section class="max-w-5xl mx-auto px-4 sm:px-6 py-10 mb-10 min-h-[80vh]">
    <div class="mb-12 border-b border-gray-200 pb-6">
      <h2 class="font-primary text-3xl sm:text-4xl font-bold text-dark">{humanize(categoria!)}</h2>
      <p class="text-text mt-2">Postagens e reflexões catalogadas sob esta disciplina.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-10 lg:gap-12">
      {filterByCategories.map((post) => (
        <article class="group flex flex-col gap-5 items-start">
          <a href={`/blog/${post.id}`} class="block w-full overflow-hidden rounded-none shadow-sm relative">
              <div class="absolute inset-0 bg-primary opacity-0 group-hover:opacity-10 transition-opacity duration-500 z-10"></div>
              <Image
                  src={post.data.image || placeholder}
                  alt={post.data.title}
                  width={800}
                  height={450}
                  class="w-full aspect-[16/9] object-cover group-hover:scale-105 transition-transform duration-700"
                  format="webp"
              />
          </a>
          <div class="flex-1 w-full">
              <div class="flex items-center space-x-2 mb-2">
                  {post.data.categories && (
                      <a href={`/categorias/${slugify(post.data.categories[0])}`} class="text-dark text-[11px] font-bold uppercase tracking-wider hover:underline">
                          {humanize(post.data.categories[0])}
                      </a>
                  )}
                  <span class="text-slate-300 text-xs">•</span>
                  <time class="text-slate-500 text-[11px] font-medium">{dateFormat(post.data.date)}</time>
              </div>
              <a href={`/blog/${post.id}`} class="block">
                  <h3 class="font-primary text-2xl sm:text-3xl font-bold text-dark group-hover:text-slate-600 transition-colors mb-2 leading-tight">
                      {post.data.title}
                  </h3>
              </a>
          </div>
        </article>
      ))}
    </div>
  </section>
</Base>