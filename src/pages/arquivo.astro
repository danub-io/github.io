---
import Base from "@/layouts/Base.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import { sortByDate } from "@/lib/utils/sortFunctions";
import dateFormat from "@/lib/utils/dateFormat";
import { humanize, slugify } from "@/lib/utils/textConverter";
import { Image } from "astro:assets";
import placeholder from "@/assets/images/placeholder.png";

// Obtém todos os posts e ordena do mais novo para o mais antigo
const posts = await getSinglePage("posts");
const sortedPosts = sortByDate(posts);
---

<Base title="Arquivo de Ensaios - GospelReads">
  <section class="py-20 md:py-32 bg-white min-h-[80vh]">
    <div class="max-w-5xl mx-auto px-6">
      
      <div class="mb-16 md:mb-24 text-center border-b border-gray-100 pb-12">
        <span class="text-primary font-bold tracking-[0.2em] text-xs uppercase mb-4 block">Arquivo Completo</span>
        <h1 class="font-primary text-5xl md:text-6xl font-bold text-dark mb-6">Todos os Ensaios</h1>
        <p class="text-gray-500 text-lg">Do mais recente ao mais antigo.</p>
      </div>

      <div class="max-w-4xl mx-auto space-y-12 md:space-y-16" id="archive-container">
        {sortedPosts.map((post, index) => (
          <article class={`post-item flex flex-col sm:flex-row items-center gap-8 group border-b border-gray-100 pb-12 last:border-0 last:pb-0 ${index >= 5 ? 'hidden opacity-0 translate-y-4' : 'opacity-100 translate-y-0'} transition-all duration-700 ease-out`}>
            
            <div class="w-full sm:w-1/3 shrink-0 overflow-hidden rounded-xl shadow-sm border border-gray-100">
              <a href={`/blog/${post.id}`} class="block" aria-label={post.data.title}>
                <Image
                  loading={index < 5 ? "eager" : "lazy"}
                  class="w-full aspect-[4/3] object-cover group-hover:scale-105 transition duration-500"
                  src={post.data.image || placeholder}
                  alt={post.data.image_alt || post.data.title}
                  width={400}
                  height={300}
                  format="webp"
                />
              </a>
            </div>

            <div class="w-full sm:w-2/3 flex flex-col justify-center">
              <div class="flex items-center space-x-3 mb-3">
                <time class="text-gray-400 text-sm font-medium tracking-wide">{dateFormat(post.data.date)}</time>
                {post.data.categories && post.data.categories.length > 0 && (
                  <>
                    <span class="text-gray-300">|</span>
                    <a href={`/categorias/${slugify(post.data.categories[0])}`} class="text-primary text-xs font-bold uppercase tracking-widest hover:text-dark transition">
                      {humanize(post.data.categories[0])}
                    </a>
                  </>
                )}
              </div>
              <a href={`/blog/${post.id}`} class="block">
                <h3 class="font-primary text-2xl md:text-3xl font-bold text-dark group-hover:text-primary transition-colors mb-4 leading-tight">
                  {post.data.title}
                </h3>
                <p class="text-gray-600 text-base leading-relaxed line-clamp-3">
                  {post.data.description || "Leia a reflexão completa sobre este tema."}
                </p>
              </a>
            </div>

          </article>
        ))}
      </div>
      
      <div id="scroll-sentinel" class="h-24 w-full flex items-center justify-center mt-8">
        <div class="spinner hidden w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
      </div>

    </div>
  </section>

  <script is:inline>
    document.addEventListener('astro:page-load', () => {
      let currentVisible = 5; // Quantidade de posts visíveis inicialmente
      const batchSize = 4;    // Quantos posts carregar por scroll
      const posts = document.querySelectorAll('.post-item');
      const sentinel = document.getElementById('scroll-sentinel');
      const spinner = sentinel?.querySelector('.spinner');

      if (!sentinel || posts.length === 0) return;

      // Só cria o observer se houver mais posts para mostrar
      if (currentVisible < posts.length) {
        const observer = new IntersectionObserver((entries) => {
          if (entries[0].isIntersecting) {
            spinner?.classList.remove('hidden');
            
            // Simula um pequeno delay para suavidade visual (300ms)
            setTimeout(() => {
              let revealed = 0;
              for (let i = currentVisible; i < posts.length && revealed < batchSize; i++) {
                posts[i].classList.remove('hidden');
                // Pequeno truque para a transição do Tailwind funcionar após remover o 'hidden'
                setTimeout(((item) => {
                  return () => {
                    item.classList.remove('opacity-0', 'translate-y-4');
                    item.classList.add('opacity-100', 'translate-y-0');
                  };
                })(posts[i]), 50);
                
                revealed++;
                currentVisible++;
              }
              spinner?.classList.add('hidden');
              
              // Se carregou tudo, remove o sentinela
              if (currentVisible >= posts.length) {
                observer.unobserve(sentinel);
                sentinel.style.display = 'none';
              }
            }, 300);
          }
        }, { rootMargin: '0px 0px 400px 0px' }); // Dispara o carregamento 400px antes de chegar ao fim

        observer.observe(sentinel);
      } else {
        sentinel.style.display = 'none';
      }
    });
  </script>
</Base>
