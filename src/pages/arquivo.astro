---
import Base from "@/layouts/Base.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import { sortByDate } from "@/lib/utils/sortFunctions";
import dateFormat from "@/lib/utils/dateFormat";
import { humanize, slugify } from "@/lib/utils/textConverter";
import { Image } from "astro:assets";
import placeholder from "@/assets/images/placeholder.png";

const posts = await getSinglePage("posts");
const sortedPosts = sortByDate(posts);
const INITIAL_LOAD = 8;
---

<Base title="Arquivo - Acervo de Postagens">
  <section class="max-w-5xl mx-auto px-4 sm:px-6 py-10 mb-10 min-h-[80vh]">
    <div class="mb-12 border-b border-gray-200 pb-6">
      <h2 class="font-primary text-3xl sm:text-4xl font-bold text-dark">Acervo Completo</h2>
      <p class="text-text mt-2">Todas as postagens publicadas, do mais recente ao mais antigo.</p>
    </div>

    <div id="archive-container" class="grid grid-cols-1 md:grid-cols-2 gap-10 lg:gap-12">
      {sortedPosts.map((post, index) => (
        <article class={`archive-item ${index >= INITIAL_LOAD ? 'hidden' : 'flex'} flex-col sm:flex-row gap-5 items-start group`}>
          <a href={`/blog/${post.id}`} class="block w-full sm:w-2/5 shrink-0 overflow-hidden rounded-xl shadow-sm relative">
              <div class="absolute inset-0 bg-primary opacity-0 group-hover:opacity-10 transition-opacity duration-500 z-10"></div>
              <Image
                  src={post.data.image || placeholder}
                  alt={post.data.title}
                  width={400}
                  height={320}
                  class="w-full aspect-[5/4] object-cover group-hover:scale-105 transition-transform duration-700"
                  format="webp"
              />
          </a>
          <div class="flex-1 w-full">
              <div class="flex items-center space-x-2 mb-2">
                  {post.data.categories && (
                      <a href={`/categorias/${slugify(post.data.categories[0])}`} class="text-dark text-[11px] font-bold uppercase tracking-wider hover:underline">
                          {humanize(post.data.categories[0])}
                      </a>
                  )}
                  <span class="text-slate-300 text-xs">•</span>
                  <time class="text-slate-500 text-[11px] font-medium">{dateFormat(post.data.date)}</time>
              </div>
              <a href={`/blog/${post.id}`} class="block">
                  <h3 class="font-primary text-xl sm:text-2xl font-bold text-dark group-hover:text-slate-600 transition-colors mb-2 leading-tight">
                      {post.data.title}
                  </h3>
                  <p class="text-text text-sm leading-relaxed line-clamp-2">
                      {post.data.description || "Leia a reflexão completa sobre este tema."}
                  </p>
              </a>
          </div>
        </article>
      ))}
    </div>

    {sortedPosts.length > INITIAL_LOAD && (
      <div id="infinite-scroll-trigger" class="w-full h-32 flex items-center justify-center mt-8">
        <div class="animate-pulse flex space-x-3 items-center">
          <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
          <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
          <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
        </div>
      </div>
    )}
  </section>

  <script is:inline>
    function initInfiniteScroll() {
      const trigger = document.getElementById('infinite-scroll-trigger');
      const hiddenPosts = Array.from(document.querySelectorAll('.archive-item.hidden'));
      const batchSize = 6; 

      if (!trigger || hiddenPosts.length === 0) return;

      const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) {
          const nextBatch = hiddenPosts.splice(0, batchSize);
          nextBatch.forEach(post => {
            post.classList.remove('hidden');
            post.classList.add('flex');
            post.style.opacity = '0';
            post.style.transition = 'opacity 0.5s ease-in-out';
            setTimeout(() => post.style.opacity = '1', 50);
          });
          if (hiddenPosts.length === 0) {
            observer.disconnect();
            trigger.style.display = 'none';
          }
        }
      }, { rootMargin: '300px' });

      observer.observe(trigger);
    }
    document.addEventListener('astro:page-load', initInfiniteScroll);
    initInfiniteScroll();
  </script>
</Base>