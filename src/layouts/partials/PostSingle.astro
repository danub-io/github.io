---
import Share from "@/components/Share.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import dateFormat from "@/lib/utils/dateFormat";
import similerItems from "@/lib/utils/similarItems";
import { humanize, markdownify, slugify } from "@/lib/utils/textConverter";
import { Image } from "astro:assets";
import { render } from "astro:content";
import placeholder from "@/assets/images/placeholder.png";

const allAuthors = await getSinglePage("authors");
const posts = await getSinglePage("posts");
const { post } = Astro.props;
const similarPosts = similerItems(post, posts, post.id);
const { Content } = await render(post);
const { title, description, authors, categories, image, image_alt, date, tags } = post.data;
---

<section class="pt-32 pb-20 bg-white">
  <div class="max-w-[800px] mx-auto px-6">
    <article>
      
      <header class="text-center mb-16">
        {categories.map((category: string) => (
          <a href={`/categorias/${slugify(category)}`} class="inline-block text-primary font-bold text-xs tracking-[0.2em] uppercase hover:text-dark transition mb-6">
            {humanize(category)}
          </a>
        ))}
        
        <h1 set:html={markdownify(title)} class="font-primary text-4xl md:text-5xl lg:text-6xl font-bold text-dark mb-8 leading-[1.15]" />

        <div class="flex items-center justify-center space-x-4 text-gray-500 text-sm font-medium">
          <time>{dateFormat(date)}</time>
          <span>&bull;</span>
          {allAuthors
            .filter((author) => authors.map((a: string) => slugify(a)).includes(slugify(author.data.title)))
            .map((author) => (
              <a href={`/autores/${slugify(author.id)}`} class="hover:text-primary transition">
                Dan Coelho
              </a>
          ))}
        </div>
      </header>

      <div class="w-full mb-16">
        {(image || placeholder) && (
          <Image
            width={1000} height={562}
            widths={[400, 800, 1000]}
            sizes="(max-width: 1024px) 100vw, 800px"
            loading="eager" fetchpriority="high"
            src={image || placeholder} alt={image_alt || title}
            class="w-full object-cover rounded-xl shadow-lg" format="webp"
          />
        )}
      </div>

      <div class="content mx-auto">
        <Content />
      </div>

      <aside class="mt-20 mb-16 bg-gray-50 border border-gray-200 rounded-2xl p-8 md:p-12 text-center">
        <h3 class="font-primary text-2xl md:text-3xl font-bold text-dark mb-4">Este texto trouxe clareza à sua mente?</h3>
        <p class="text-gray-600 text-lg max-w-xl mx-auto mb-8 leading-relaxed">
          O <strong>GospelReads</strong> é um ministério de escrita mantido inteiramente por leitores. Sem anúncios, sem algoritmos tóxicos. Se este ensaio curou sua mente ou auxiliou sua liderança, considere apoiar a missão.
        </p>
        <div class="flex flex-col sm:flex-row justify-center gap-4">
          <a href="/#assinar" class="bg-dark hover:bg-gray-800 text-white px-8 py-4 rounded font-bold transition shadow-md">
            Tornar-se Mantenedor
          </a>
          <a href="/#livros" class="bg-white border border-gray-300 text-dark hover:bg-gray-100 px-8 py-4 rounded font-bold transition">
            Acessar Manuais
          </a>
        </div>
      </aside>

      <footer class="flex flex-col md:flex-row items-center justify-between border-t border-gray-200 pt-8 mt-12">
        <ul class="flex flex-wrap gap-2 mb-6 md:mb-0">
          {tags.map((tag: string) => (
            <li>
              <a href={`/tags/${slugify(tag)}`} class="block bg-gray-100 px-4 py-2 rounded text-gray-600 text-sm font-medium hover:bg-dark hover:text-white transition">
                #{humanize(tag)}
              </a>
            </li>
          ))}
        </ul>
        <Share className="flex gap-4 text-xl text-gray-400 hover:text-dark transition" title={title} description={description} slug={post.id} />
      </footer>

    </article>
  </div>
</section>

