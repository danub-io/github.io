---
import Share from "@/components/Share.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import dateFormat from "@/lib/utils/dateFormat";
import similerItems from "@/lib/utils/similarItems";
import { humanize, markdownify, slugify } from "@/lib/utils/textConverter";
import { Image } from "astro:assets";
import { render } from "astro:content";
import placeholder from "@/assets/images/placeholder.png";

const allAuthors = await getSinglePage("authors");
const posts = await getSinglePage("posts");
const { post } = Astro.props;
const similarPosts = similerItems(post, posts, post.id);
const { Content } = await render(post);
const { title, description, authors, categories, image, image_alt, date, tags } = post.data;
const recommendedPosts = [
  ...similarPosts,
  ...posts.filter((p) => p.id !== post.id && !similarPosts.find((sp) => sp.id === p.id))
].slice(0, 6);
---

<section class="py-16 md:py-24 bg-body">
  <div class="max-w-5xl mx-auto px-4 sm:px-6">
    <article class="flex flex-col items-center">
      
      <div class="w-full max-w-3xl text-left">
        <div class="flex items-center flex-wrap mb-6">
          {categories.map((category: string) => (
            <a
              href={`/categorias/${slugify(category)}`}
              class="text-dark font-bold normal-case text-sm tracking-widest uppercase hover:text-slate-600 hover:underline mr-4"
            >
              {humanize(category)}
            </a>
          ))}
        </div>

        <h1 set:html={markdownify(title)} class="font-primary text-4xl md:text-6xl font-bold text-dark mb-8 leading-tight" />

        <ul class="flex flex-wrap items-center justify-start text-slate-500 text-base mb-12 border-b border-gray-200 pb-8">
          <li class="mr-6 font-medium flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            {dateFormat(date)}
          </li>
          <li class="flex items-center">
            {allAuthors
              .filter((author) => authors.map((a: string) => slugify(a)).includes(slugify(author.data.title)))
              .map((author) => (
                <a href={`/autores/${slugify(author.id)}`} class="hover:text-dark transition font-medium">
                  <span class="text-slate-700">Por {author.data.title}</span>
                </a>
            ))}
          </li>
        </ul>
      </div>

      <div class="w-full max-w-4xl mb-16 flex justify-center">
        {(image || placeholder) && (
          <Image
            width={900}
            height={500}
            widths={[400, 700, 900]}
            sizes="(max-width: 1024px) 95vw, 900px"
            loading="eager"
            fetchpriority="high"
            src={image || placeholder}
            alt={image_alt || title}
            class="object-cover aspect-[16/9] rounded-2xl shadow-md w-full border border-gray-100"
            format="webp"
          />
        )}
      </div>

      <div class="w-full max-w-3xl">
        <div class="content mb-20 text-left text-lg md:text-xl leading-relaxed text-slate-800" id="article-content">
          <Content />
        </div>

        <div class="bg-white border border-gray-200 p-8 md:p-12 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-16 text-center relative overflow-hidden group">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-amber-300"></div>
          <h3 class="font-primary text-2xl md:text-3xl font-bold text-dark mb-4 md:mb-6">Esta postagem trouxe clareza à sua mente?</h3>
          <p class="text-text mb-8 md:mb-10 text-base md:text-lg max-w-xl mx-auto leading-relaxed">
            O <strong>GospelReads</strong> é um refúgio literário mantido inteiramente por leitores. Sem anúncios invasivos, sem algoritmos tóxicos. Se esta postagem ajudou no seu ministério ou curou a sua mente hoje, considere apoiar a nossa missão.
          </p>
          <div class="flex flex-col sm:flex-row justify-center gap-4">
            <a href="/#assinar" class="bg-dark hover:bg-slate-800 text-white px-8 py-4 rounded-md font-semibold transition-all shadow-md">
              Apoiar a Missão
            </a>
            <a href="/#livros" class="bg-white border border-gray-300 text-dark hover:bg-gray-50 px-8 py-4 rounded-md font-semibold transition-all">
              Conheça a Biblioteca
            </a>
          </div>
        </div>

        <div class="flex flex-col md:flex-row items-center justify-between border-t border-gray-200 pt-8 mt-8">
          <ul class="flex flex-wrap gap-2 mb-6 md:mb-0">
            {tags.map((tag: string) => (
              <li>
                <a
                  href={`/tags/${slugify(tag)}`}
                  class="block rounded-md bg-slate-50 border border-gray-200 px-4 py-2 font-medium text-slate-500 text-sm hover:text-dark hover:bg-white hover:border-slate-400 transition duration-300"
                >
                  #{humanize(tag)}
                </a>
              </li>
            ))}
          </ul>
          <Share
            className="social-share"
            title={title}
            description={description}
            slug={post.id}
          />
        </div>
      </div>
    </article>
  </div>
</section>

<section class="max-w-5xl mx-auto px-4 sm:px-6 py-10 mb-10 border-t border-gray-100 mt-16 pt-16">
  <div class="mb-12 border-b border-gray-200 pb-6">
    <h2 class="font-primary text-3xl sm:text-4xl font-bold text-dark">Reflexões Semelhantes</h2>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-10 lg:gap-12">
    {recommendedPosts.map((p) => (
      <article class="group flex flex-col sm:flex-row gap-5 items-start">
        <a href={`/blog/${p.id}`} class="block w-full sm:w-2/5 shrink-0 overflow-hidden rounded-xl shadow-sm relative">
            <div class="absolute inset-0 bg-primary opacity-0 group-hover:opacity-10 transition-opacity duration-500 z-10"></div>
            <Image
                loading="lazy"
                src={p.data.image || placeholder}
                alt={p.data.image_alt || p.data.title}
                width={400}
                height={320}
                class="w-full aspect-[5/4] object-cover group-hover:scale-105 transition-transform duration-700"
                format="webp"
            />
        </a>
        <div class="flex-1 w-full">
            <div class="flex items-center space-x-2 mb-2">
                {p.data.categories && p.data.categories.length > 0 && (
                    <a href={`/categorias/${slugify(p.data.categories[0])}`} class="text-dark text-[11px] font-bold uppercase tracking-wider hover:underline">
                        {humanize(p.data.categories[0])}
                    </a>
                )}
                <span class="text-slate-300 text-xs">•</span>
                <time class="text-slate-500 text-[11px] font-medium">{dateFormat(p.data.date)}</time>
            </div>
            <a href={`/blog/${p.id}`} class="block">
                <h3 class="font-primary text-xl sm:text-2xl font-bold text-dark group-hover:text-slate-600 transition-colors mb-2 leading-tight">
                    {p.data.title}
                </h3>
                <p class="text-text text-sm leading-relaxed line-clamp-2">
                    {p.data.description || "Leia a reflexão completa sobre este tema."}
                </p>
            </a>
        </div>
      </article>
    ))}
  </div>
</section>
