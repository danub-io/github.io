---
import Share from "@/components/Share.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import dateFormat from "@/lib/utils/dateFormat";
import similerItems from "@/lib/utils/similarItems";
import { humanize, markdownify, slugify } from "@/lib/utils/textConverter";
import { Image } from "astro:assets";
import { render } from "astro:content";
import placeholder from "@/assets/images/placeholder.png";
import config from "@/config/config.json";

const allAuthors = await getSinglePage("authors");
const posts = await getSinglePage("posts");
const { post } = Astro.props;
const similarPosts = similerItems(post, posts, post.id);
const { Content } = await render(post);
const { title, description, authors, image, image_alt, date, tags } = post.data;
const recommendedPosts = [
  ...similarPosts,
  ...posts.filter((p) => p.id !== post.id && !similarPosts.find((sp) => sp.id === p.id))
].slice(0, 6);

const { support_url } = config.params;
---

<section class="py-16 md:py-24 bg-body">
  <div class="max-w-5xl mx-auto px-4 sm:px-6">
    <article class="flex flex-col items-center">
      
      <div class="w-full max-w-3xl text-left">
        <div class="flex items-center flex-wrap mb-6">
          {tags && tags.length > 0 && (
            <a
              href={`/tags/${slugify(tags[0])}`}
              class="text-dark font-bold normal-case text-sm tracking-widest uppercase hover:text-slate-600 hover:underline mr-4"
            >
              {humanize(tags[0])}
            </a>
          )}
        </div>

        <h1 set:html={markdownify(title)} class="font-primary text-4xl md:text-6xl font-bold text-dark mb-8 leading-tight" />

        <ul class="flex flex-wrap items-center justify-start text-base mb-6 md:mb-10 border-b border-gray-200 pb-5 md:pb-6">
          <li class="mr-6 flex items-center">
            <span class="text-slate-700 font-medium">{dateFormat(date)}</span>
          </li>
          <li class="flex items-center">
            {allAuthors
              .filter((author) => authors.map((a: string) => slugify(a)).includes(slugify(author.data.title)))
              .map((author) => (
                <a href={`/autores/${slugify(author.id)}`} class="hover:text-dark transition font-medium">
                  <span class="text-slate-700">Por {author.data.title}</span>
                </a>
            ))}
          </li>
        </ul>
      </div>

      <div class="w-full max-w-4xl mb-8 md:mb-12 flex justify-center">
        {(image || placeholder) && (
          <Image
            width={900}
            height={500}
            widths={[400, 700, 900]}
            sizes="(max-width: 1024px) 95vw, 900px"
            loading="eager"
            fetchpriority="high"
            src={image || placeholder}
            alt={image_alt || title}
            class="object-cover aspect-[16/9] rounded-none shadow-md w-full border border-gray-100"
            format="webp"
          />
        )}
      </div>

      <div class="w-full max-w-3xl">
        <div class="content mb-20 text-left text-lg md:text-xl leading-relaxed text-slate-800" id="article-content">
          <Content />
        </div>

        <div class="bg-white border border-gray-200 p-8 md:p-12 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-16 text-center relative overflow-hidden group">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-amber-300"></div>
          <h2 class="font-primary text-2xl md:text-3xl font-bold text-dark mb-4 md:mb-6">Esta postagem trouxe clareza à sua mente?</h2>
          <p class="text-text mb-8 md:mb-10 text-base md:text-lg max-w-xl mx-auto leading-relaxed">
            O <strong>GospelReads</strong> é um refúgio literário mantido inteiramente por leitores. Sem anúncios invasivos, sem algoritmos tóxicos. Se esta postagem ajudou no seu ministério ou curou a sua mente hoje, considere apoiar a nossa missão.
          </p>
          <div class="flex flex-col sm:flex-row justify-center gap-4">
            <a href={support_url} class="bg-dark hover:bg-slate-800 text-white px-8 py-4 rounded-none font-semibold transition-all shadow-md">
              Apoiar a Missão
            </a>
            <a href="/#livros" class="bg-white border border-gray-300 text-dark hover:bg-gray-50 px-8 py-4 rounded-none font-semibold transition-all">
              Conheça a Biblioteca
            </a>
          </div>
        </div>

        <div class="flex flex-col md:flex-row items-center justify-between border-t border-gray-200 pt-8 mt-8">
          <div class="mb-6 md:mb-0">
            {tags && tags.length > 0 && (
              <a
                href={`/tags/${slugify(tags[0])}`}
                class="inline-block rounded-none bg-slate-50 border border-gray-200 px-4 py-2 font-medium text-slate-500 text-sm hover:text-dark hover:bg-white hover:border-slate-400 transition duration-300"
              >
                #{humanize(tags[0])}
              </a>
            )}
          </div>
          <Share
            className="social-share"
            title={title}
            description={description}
            slug={post.id}
          />
        </div>
      </div>
    </article>
  </div>
</section>

<section class="max-w-5xl mx-auto px-4 sm:px-6 py-10 mb-10 border-t border-gray-100 mt-16 pt-16">
  <div class="mb-12 border-b border-gray-200 pb-6">
    <h2 class="font-primary text-3xl sm:text-4xl font-bold text-dark">Reflexões Semelhantes</h2>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-10 lg:gap-12">
    {recommendedPosts.map((p) => (
      <article class="group flex flex-col gap-5 items-start">
        <a href={`/blog/${p.id}`} class="block w-full overflow-hidden rounded-none shadow-sm relative">
            <div class="absolute inset-0 bg-primary opacity-0 group-hover:opacity-10 transition-opacity duration-500 z-10"></div>
            <Image
                loading="lazy"
                src={p.data.image || placeholder}
                alt={p.data.image_alt || p.data.title}
                width={800}
                height={450}
                widths={[400, 600, 800]}
                sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 450px"
                class="w-full aspect-[16/9] object-cover group-hover:scale-105 transition-transform duration-700"
                format="webp"
            />
        </a>
        <div class="flex-1 w-full">
            <div class="flex items-center space-x-2 mb-2">
                {p.data.tags && p.data.tags.length > 0 && (
                    <a href={`/tags/${slugify(p.data.tags[0])}`} class="text-dark text-[11px] font-bold uppercase tracking-wider hover:underline">
                        {humanize(p.data.tags[0])}
                    </a>
                )}
                <span class="text-slate-300 text-xs">•</span>
                <time class="text-slate-500 text-[11px] font-medium">{dateFormat(p.data.date)}</time>
            </div>
            <a href={`/blog/${p.id}`} class="block">
                <h3 class="font-primary text-2xl sm:text-3xl font-bold text-dark group-hover:text-slate-600 transition-colors mb-2 leading-tight">
                    {p.data.title}
                </h3>
            </a>
        </div>
      </article>
    ))}
  </div>
</section>