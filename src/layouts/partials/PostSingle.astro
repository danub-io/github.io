---
import Share from "@/components/Share.astro";
import AdDummy from "@/components/AdDummy.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import dateFormat from "@/lib/utils/dateFormat";
import similerItems from "@/lib/utils/similarItems";
import { humanize, markdownify, slugify } from "@/lib/utils/textConverter";
import { Image } from "astro:assets";
import { render } from "astro:content";
import placeholder from "@/assets/images/placeholder.png";

const allAuthors = await getSinglePage("authors");
const posts = await getSinglePage("posts");
const { post } = Astro.props;
const similarPosts = similerItems(post, posts, post.id);
const { Content } = await render(post);
const { title, description, authors, categories, image, image_alt, date, tags } =
  post.data;

// Combine similar posts with others to get more recommended posts (up to 40)
const recommendedPosts = [
  ...similarPosts,
  ...posts.filter((p) => p.id !== post.id && !similarPosts.find((sp) => sp.id === p.id))
].slice(0, 40);
---

<section class="py-6">
  <div class="max-w-[1000px] px-4 mx-auto">
    <!-- Top Ad Dummy -->
    <AdDummy className="mt-0 mb-8" />

    <article class="flex flex-col items-center">
      <div class="w-full text-left">
        <!-- Categories above title -->
        <div class="flex items-center flex-wrap mb-2">
          {
            categories.map((category: string) => (
              <a
                href={`/categorias/${slugify(category)}`}
                class="text-primary font-bold normal-case text-[10px] sm:text-xs tracking-wide hover:underline mr-2 pb-1"
              >
                {humanize(category)}
              </a>
            ))
          }
        </div>

        <h1 set:html={markdownify(title)} class="h1 mb-4 text-left" />

        <!-- Author and Date meta -->
        <ul class="flex flex-wrap items-center justify-start text-text-light text-xs">
          <li class="mr-4">
            {
              allAuthors
                .filter((author) =>
                  authors
                    .map((author: string) => slugify(author))
                    .includes(slugify(author.data.title))
                )
                .map((author) => (
                  <a
                    href={`/autores/${slugify(author.id)}`}
                    class="hover:text-primary font-medium"
                  >
                    <span>{author.data.title}</span>
                  </a>
                ))
            }
          </li>
          <li class="font-medium">
            {dateFormat(date)}
          </li>
        </ul>
      </div>

      <div class="w-full mt-8 mb-2 flex justify-center">
        {
          (image || placeholder) && (
            <Image
              width={1000}
              height={500}
              widths={[400, 700, 1000]}
              sizes="(max-width: 768px) 95vw, 1000px"
              loading="eager"
              fetchpriority="high"
              src={image || placeholder}
              alt={image_alt || title}
              class="object-cover aspect-[21/9] sm:aspect-[3/1]"
              format="webp"
            />
          )
        }
      </div>

      <div class="w-full">
        <div class="content mb-10 text-left" id="article-content">
          <Content />
        </div>
        <div class="flex flex-wrap items-center justify-between">
          <ul class="mr-4 mb-4 space-x-3">
            {
              tags.map((tag: string) => (
                <li class="inline-block mb-2">
                  <a
                    href={`/tags/${slugify(tag)}`}
                    class="block rounded-lg bg-light px-4 py-3 font-semibold text-dark text-sm hover:text-primary transition duration-300"
                  >
                    #{humanize(tag)}
                  </a>
                </li>
              ))
            }
          </ul>
          <Share
            className="social-share mb-4"
            title={title}
            description={description}
            slug={post.id}
          />
        </div>
      </div>
    </article>
  </div>
</section>

<!-- recommended posts -->
<section class="py-6 pt-0">
  <div class="max-w-[1000px] px-4 mx-auto">
    <h2 class="mb-8 text-left h1">Recomendados</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8" id="recommended-container">
      {recommendedPosts.map((p, index) => (
        <>
          {index === 3 && (
            <div class="col-span-1 md:col-span-2 mb-6">
              <AdDummy className="mt-0 mb-8" />
            </div>
          )}
          <div class={`recommended-item col-span-1 flex items-start gap-3 sm:gap-4 mb-6 ${index >= 10 ? 'hidden' : ''}`}>
            {(p.data.image || placeholder) && (
              <a href={`/blog/${p.id}`} class="block hover:text-primary overflow-hidden group flex-shrink-0 w-[40%]" aria-label={p.data.title}>
                <Image
                  loading="lazy"
                  class="group-hover:scale-[1.03] transition duration-300 w-full aspect-[5/3] object-cover"
                  src={p.data.image || placeholder}
                  alt={p.data.image_alt || p.data.title}
                  width={300}
                  height={180}
                  widths={[150, 300, 600]}
                  sizes="(max-width: 640px) 35vw, 300px"
                  format="webp"
                />
              </a>
            )}
            <div class="flex-grow">
              {p.data.categories && p.data.categories.length > 0 && (
                <div class="flex items-center flex-wrap mb-1">
                  {p.data.categories.map((category: string, i: number) => (
                    <a
                      href={`/categorias/${slugify(category)}`}
                      class="text-primary font-bold normal-case text-[10px] sm:text-xs tracking-wide hover:underline mr-2 pb-1 px-2 -ml-2"
                    >
                      {humanize(category)}
                      {i !== p.data.categories.length - 1 && <span class="mx-1">,</span>}
                    </a>
                  ))}
                </div>
              )}
              <h3 class="text-[16px] sm:text-lg leading-tight sm:leading-snug">
                <a href={`/blog/${p.id}`} class="block hover:text-primary transition duration-300 font-bold pb-1">
                  {p.data.title}
                </a>
              </h3>
            </div>
          </div>
        </>
      ))}
    </div>

    {recommendedPosts.length > 10 && (
      <div class="flex justify-center mt-12 mb-16">
        <button
          id="load-more-recommended"
          class="bg-[#0077B5] hover:bg-[#005a8a] text-white px-6 py-1 font-bold text-base uppercase tracking-widest transition-all duration-300 shadow-md hover:shadow-xl active:scale-95 flex items-center gap-2"
        >
          <span>Ver Mais Postagens</span>
          <svg class="w-5 h-5 animate-bounce-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
      </div>
    )}
  </div>
</section>


<script>
  function injectMiddleAd() {
    const content = document.getElementById('article-content');
    if (!content || content.querySelector('.middle-ad-dummy')) return;

    const paragraphs = content.querySelectorAll('p');
    if (paragraphs.length >= 3) {
      const middleIndex = Math.floor(paragraphs.length / 2);
      const adDummy = document.createElement('div');
      adDummy.className = "my-8 flex justify-center middle-ad-dummy";
      adDummy.innerHTML = `
        <div class="w-full max-w-[728px] h-[90px] bg-gray-200 flex items-center justify-center text-gray-500 font-bold border border-gray-300">
          Publicidade
        </div>
      `;
      paragraphs[middleIndex].parentNode?.insertBefore(adDummy, paragraphs[middleIndex].nextSibling);
    }
  }

  document.addEventListener('astro:page-load', injectMiddleAd);
  // Also run on initial load if not using view transitions or if it's the first page
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    injectMiddleAd();
  } else {
    document.addEventListener('DOMContentLoaded', injectMiddleAd);
  }

  function setupLoadMoreRecommended() {
    const button = document.getElementById('load-more-recommended');
    if (!button || button.hasAttribute('data-initialized')) return;
    button.setAttribute('data-initialized', 'true');

    button.addEventListener('click', () => {
      const hiddenItems = Array.from(document.querySelectorAll('.recommended-item.hidden'));
      const toShow = hiddenItems.slice(0, 6);

      toShow.forEach(item => {
        item.classList.remove('hidden');
      });

      if (hiddenItems.length <= 6) {
        button.parentElement?.remove();
      }
    });
  }

  document.addEventListener('astro:page-load', setupLoadMoreRecommended);
  setupLoadMoreRecommended();
</script>
