---
import Logo from "@/components/Logo.astro";
import menu from "@/config/menu.json";
import { IoSearch, IoClose } from "react-icons/io5";

export interface ChildNavigationLink {
  name: string;
  url: string;
}

export interface NavigationLink {
  name: string;
  url: string;
  hasChildren?: boolean;
  children?: ChildNavigationLink[];
}

const { main }: { main: NavigationLink[] } = menu;
---

<header class="header pt-6 relative">
  <nav class="navbar container relative">
    <div class="order-0">
      <Logo />
    </div>

    <input id="nav-toggle" type="checkbox" class="hidden" />
    <label
      id="show-button"
      for="nav-toggle"
      class="order-2 flex cursor-pointer items-center text-black md:order-1 md:hidden"
    >
      <svg class="h-6 fill-current" viewBox="0 0 20 20">
        <title>Menu Open</title>
        <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
      </svg>
    </label>
    <label
      id="hide-button"
      for="nav-toggle"
      class="order-2 hidden cursor-pointer items-center text-black md:order-1"
    >
      <svg class="h-6 fill-current" viewBox="0 0 20 20">
        <title>Menu Close</title>
        <polygon
          points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
          transform="rotate(45 10 10)"></polygon>
      </svg>
    </label>
    <ul
      id="nav-menu"
      class="navbar-nav order-3 hidden w-full md:order-1 md:flex md:w-auto"
    >
      {
        main.map((menu) => (
          <>
            {menu.hasChildren ? (
              <li class="nav-item nav-dropdown group relative cursor-pointer">
                <span class="nav-link inline-flex items-center">
                  {menu.name}
                  <svg class="h-5 w-5 fill-current" viewBox="0 0 20 20">
                    <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                  </svg>
                </span>
                <ul class="nav-dropdown-list hidden group-hover:block md:invisible md:absolute md:block md:opacity-0 md:group-hover:visible md:group-hover:opacity-100">
                  {menu.children?.map((child) => (
                    <li class="nav-dropdown-item">
                      <a href={child.url} class="nav-dropdown-link">
                        {child.name}
                      </a>
                    </li>
                  ))}
                </ul>
              </li>
            ) : (
              <li class="nav-item">
                <a href={menu.url} class="nav-link block">
                  {menu.name}
                </a>
              </li>
            )}
          </>
        ))
      }
      
      <li class="nav-item md:hidden w-full mt-8 px-4">
        <form action="/" method="GET" class="relative w-full max-w-sm mx-auto">
          <input 
            type="text" 
            name="q" 
            placeholder="Buscar no GospelReads..." 
            class="form-input w-full rounded-full border-border py-3 pl-6 pr-12 focus:border-primary focus:ring-0 text-dark bg-light"
          />
          <button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 text-primary text-xl">
            <IoSearch />
          </button>
        </form>
      </li>
    </ul>

    <div class="order-1 ml-auto flex items-center md:order-2 lg:ml-0">
      <button
        class="search-icon p-2 text-dark hover:text-[#0077B5] transition hidden md:inline-block cursor-pointer"
        aria-label="search"
        data-search-trigger
      >
        <IoSearch />
      </button>
    </div>

    <div class="search-modal" id="search-modal">
      <button
        class="search-close z-50 absolute right-4 top-4 text-3xl text-dark cursor-pointer hover:text-primary transition"
        id="search-close"
        aria-label="close search"
      >
        <IoClose />
      </button>
      
      <div class="container h-full flex items-center justify-center">
        <form action="/" method="GET" class="relative w-full max-w-3xl">
          <input
            class="form-input w-full border-0 border-b-2 border-border bg-transparent pb-4 text-3xl text-dark placeholder:text-gray-400 focus:border-primary focus:ring-0 text-center"
            placeholder="O que você procura hoje?"
            type="text"
            name="q"
            id="search-input-desktop"
            autocomplete="off"
          />
        </form>
      </div>
    </div>

  </nav>
</header>

<script>
  // Script compatível com View Transitions (Astro)
  // Garante que funcione mesmo navegando entre páginas sem recarregar
  document.addEventListener('astro:page-load', () => {
    const searchModal = document.getElementById('search-modal');
    const searchTriggers = document.querySelectorAll('[data-search-trigger]');
    const searchClose = document.getElementById('search-close');
    const searchInput = document.getElementById('search-input-desktop');

    // Abrir Modal
    searchTriggers.forEach((trigger) => {
      trigger.addEventListener('click', () => {
        searchModal?.classList.add('open');
        setTimeout(() => searchInput?.focus(), 100); // Foca no campo automaticamente
      });
    });

    // Fechar Modal (Botão X)
    searchClose?.addEventListener('click', () => {
      searchModal?.classList.remove('open');
    });

    // Fechar com ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchModal?.classList.remove('open');
      }
    });
    
    // Fechar clicando fora (Opcional, mas útil)
    searchModal?.addEventListener('click', (e) => {
      if (e.target === searchModal) {
        searchModal.classList.remove('open');
      }
    });
  });
</script>