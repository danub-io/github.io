---
import Logo from "@/components/Logo.astro";
import menu from "@/config/menu.json";
import { IoSearch, IoClose } from "react-icons/io5";
import { getTaxonomy } from "@/lib/taxonomyParser.astro";
import { humanize } from "@/lib/utils/textConverter";

const categories = await getTaxonomy("posts", "categories");

export interface ChildNavigationLink {
  name: string;
  url: string;
}

export interface NavigationLink {
  name: string;
  url: string;
  hasChildren?: boolean;
  children?: ChildNavigationLink[];
}

const { main }: { main: NavigationLink[] } = menu;
---

<header class="header pt-6 relative z-30">
  <nav class="navbar container relative">
    <div class="order-0">
      <Logo />
    </div>

    <input id="nav-toggle" type="checkbox" class="hidden" />
    <label
      id="show-button"
      for="nav-toggle"
      class="order-2 flex cursor-pointer items-center text-black md:order-1 md:hidden"
    >
      <svg class="h-6 fill-current" viewBox="0 0 20 20">
        <title>Menu Open</title>
        <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
      </svg>
    </label>
    <label
      id="hide-button"
      for="nav-toggle"
      class="order-2 hidden cursor-pointer items-center text-black md:order-1"
    >
      <svg class="h-6 fill-current" viewBox="0 0 20 20">
        <title>Menu Close</title>
        <polygon
          points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
          transform="rotate(45 10 10)"></polygon>
      </svg>
    </label>
    <ul
      id="nav-menu"
      class="navbar-nav order-3 hidden w-full md:order-1 md:flex md:w-auto"
    >
      {
        main.map((menu) => (
          <>
            {menu.name === "Categorias" ? (
              <>
                {/* Categorias no mobile: lista plana para espaçamento uniforme */}
                {categories.map((category) => (
                  <li class="nav-item md:hidden">
                    <a
                      href={`/categorias/${category}`}
                      class="nav-link block"
                    >
                      {humanize(category)}
                    </a>
                  </li>
                ))}
                {/* Categorias no desktop: link único para a página de categorias */}
                <li class="nav-item hidden md:block">
                  <a href={menu.url} class="nav-link block">
                    {menu.name}
                  </a>
                </li>
              </>
            ) : menu.hasChildren ? (
              <li class="nav-item nav-dropdown group relative cursor-pointer">
                <span class="nav-link inline-flex items-center">
                  {menu.name}
                  <svg class="h-5 w-5 fill-current" viewBox="0 0 20 20">
                    <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                  </svg>
                </span>
                <ul class="nav-dropdown-list hidden group-hover:block md:invisible md:absolute md:block md:opacity-0 md:group-hover:visible md:group-hover:opacity-100">
                  {menu.children?.map((child) => (
                    <li class="nav-dropdown-item">
                      <a href={child.url} class="nav-dropdown-link">
                        {child.name}
                      </a>
                    </li>
                  ))}
                </ul>
              </li>
            ) : (
              <li class="nav-item">
                <a href={menu.url} class="nav-link block">
                  {menu.name}
                </a>
              </li>
            )}
          </>
        ))
      }
      
      <li class="nav-item md:hidden w-full mt-10 px-4">
        <form action="/search" method="GET" class="relative w-full max-w-sm mx-auto">
          <input 
            type="text" 
            name="q" 
            placeholder="Buscar no GospelReads..." 
            class="form-input w-full rounded-full border-border py-4 pl-6 pr-12 focus:border-primary focus:ring-0 text-dark bg-light"
          />
          <button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 text-primary text-2xl">
            <IoSearch />
          </button>
        </form>
      </li>
    </ul>

    <div class="order-1 ml-auto flex items-center md:order-2 lg:ml-0">
      <button
        class="search-icon p-2 text-dark hover:text-primary transition hidden md:inline-block cursor-pointer"
        aria-label="search"
        data-search-trigger
      >
        <IoSearch />
      </button>
    </div>

    <div 
      class="fixed inset-0 z-50 flex items-start justify-center pt-[15vh] bg-stone-900/60 backdrop-blur-sm opacity-0 invisible transition-all duration-300" 
      id="search-modal"
    >
      <div class="absolute inset-0" id="search-backdrop"></div>

      <div class="relative w-full max-w-2xl mx-4 bg-white rounded-2xl shadow-2xl transform scale-95 transition-all duration-300" id="search-container">
        
        <form action="/search" method="GET" class="relative flex items-center">
          <span class="absolute left-6 text-gray-400 text-2xl">
            <IoSearch />
          </span>

          <input
            class="w-full bg-transparent py-6 pl-16 pr-16 text-xl text-dark placeholder:text-gray-400 border-0 focus:ring-0 rounded-2xl outline-none"
            placeholder="Buscar..."
            type="text"
            name="q"
            id="search-input-desktop"
            autocomplete="off"
          />

          <button
            type="button"
            class="absolute right-4 p-2 text-gray-400 hover:text-dark transition cursor-pointer"
            id="search-close"
            aria-label="close search"
          >
            <IoClose class="text-2xl" />
          </button>
        </form>
        
        <div class="px-6 py-3 bg-gray-50 rounded-b-2xl border-t border-gray-100 text-xs text-gray-500 flex justify-between">
          <span>Pressione <strong>Enter</strong> para buscar</span>
          <span><strong>ESC</strong> para fechar</span>
        </div>
      </div>
    </div>

  </nav>
</header>

<script>
  const openSearch = (e) => {
    e.preventDefault();
    const searchModal = document.getElementById('search-modal');
    const searchContainer = document.getElementById('search-container');
    const searchInput = document.getElementById('search-input-desktop') as HTMLInputElement;
    if (searchModal && searchContainer) {
      searchModal.classList.remove('invisible', 'opacity-0');
      searchModal.classList.add('visible', 'opacity-100');
      searchContainer.classList.remove('scale-95');
      searchContainer.classList.add('scale-100');
      setTimeout(() => searchInput?.focus(), 100);
    }
  };

  const closeSearch = () => {
    const searchModal = document.getElementById('search-modal');
    const searchContainer = document.getElementById('search-container');
    if (searchModal && searchContainer) {
      searchModal.classList.remove('visible', 'opacity-100');
      searchModal.classList.add('invisible', 'opacity-0');
      searchContainer.classList.remove('scale-100');
      searchContainer.classList.add('scale-95');
    }
  };

  function setupSearch() {
    const searchTriggers = document.querySelectorAll('[data-search-trigger]');
    const searchClose = document.getElementById('search-close');
    const searchBackdrop = document.getElementById('search-backdrop');

    searchTriggers.forEach((t) => {
      t.removeEventListener('click', openSearch);
      t.addEventListener('click', openSearch);
    });

    searchClose?.removeEventListener('click', closeSearch);
    searchClose?.addEventListener('click', closeSearch);

    searchBackdrop?.removeEventListener('click', closeSearch);
    searchBackdrop?.addEventListener('click', closeSearch);
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeSearch();
  });

  // Correr após navegação (Astro)
  document.addEventListener('astro:page-load', setupSearch);
</script>