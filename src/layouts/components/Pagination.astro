---
const { section, currentPage, totalPages } = Astro.props;

const indexPageLink = currentPage === 2;
const hasPrevPage = currentPage > 1;
const hasNextPage = totalPages > currentPage;

let pageList = [];
for (let i = 1; i <= totalPages; i++) {
  pageList.push(i);
}
---

{
  totalPages > currentPage && (
    <div class="flex justify-center mt-12 mb-16">
      <button
        id="load-more-button"
        data-current-page={currentPage}
        data-total-pages={totalPages}
        data-section={section || ""}
        class="bg-[#0077B5] hover:bg-[#005a8a] text-white px-6 py-1 font-bold text-base uppercase tracking-widest transition-all duration-300 shadow-md hover:shadow-xl active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
      >
        <span>Ver Mais Postagens</span>
        <svg class="w-5 h-5 animate-bounce-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
    </div>
  )
}

<style>
  .auto-loading {
    opacity: 0;
    pointer-events: none;
    height: 1px;
    margin: 0;
  }
</style>

<script>
  function setupLoadMore() {
    const button = document.getElementById('load-more-button') as HTMLButtonElement;
    if (!button || button.hasAttribute('data-initialized')) return;
    button.setAttribute('data-initialized', 'true');

    let currentPage = parseInt(button.getAttribute('data-current-page') || '1');
    const totalPages = parseInt(button.getAttribute('data-total-pages') || '1');
    const section = button.getAttribute('data-section') || '';

    // Auto-load logic: Page 1 is initial. Page 2, 3, 4 are auto-loaded.
    // Total secondary posts after Page 4: 6 (P1) + 6 (P2) + 6 (P3) + 6 (P4) = 24.
    const shouldAutoLoad = () => currentPage < 4 && section === '';

    const updateButtonStyle = () => {
      if (shouldAutoLoad()) {
        button.parentElement?.classList.add('auto-loading');
      } else {
        button.parentElement?.classList.remove('auto-loading');
      }
    };

    updateButtonStyle();

    const loadMore = async () => {
      if (button.getAttribute('disabled')) return;

      button.setAttribute('disabled', 'true');
      const originalContent = button.innerHTML;
      button.innerHTML = '<span>Carregando...</span>';

      const nextPage = currentPage + 1;
      const url = section ? `/${section}/page/${nextPage}` : `/page/${nextPage}`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Falha ao carregar mais postagens');

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const postsContainer = document.querySelector('#posts-container .grid');
        const newPostsContainer = doc.querySelector('#posts-container .grid');

        if (postsContainer && newPostsContainer) {
          const newPosts = Array.from(newPostsContainer.children);
          newPosts.forEach(post => {
            postsContainer.appendChild(post);
          });

          currentPage = nextPage;
          button.setAttribute('data-current-page', currentPage.toString());

          if (currentPage >= totalPages) {
            button.parentElement?.remove();
          } else {
            button.removeAttribute('disabled');
            button.innerHTML = originalContent;
            updateButtonStyle();
          }
        }
      } catch (error) {
        console.error(error);
        button.innerHTML = '<span>Erro ao carregar. Tente novamente.</span>';
        button.removeAttribute('disabled');
      }
    };

    button.addEventListener('click', loadMore);

    // Intersection Observer for Auto-load
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting && shouldAutoLoad() && !button.getAttribute('disabled')) {
        loadMore();
      }
    }, { rootMargin: '400px' });

    observer.observe(button);
  }

  setupLoadMore();
  document.addEventListener('astro:page-load', setupLoadMore);
</script>

