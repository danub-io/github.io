---
const { section, currentPage, totalPages } = Astro.props;

const indexPageLink = currentPage === 2;
const hasPrevPage = currentPage > 1;
const hasNextPage = totalPages > currentPage;

let pageList = [];
for (let i = 1; i <= totalPages; i++) {
  pageList.push(i);
}
---

{
  totalPages > currentPage && (
    <div class="flex justify-center mt-10 mb-10">
      <button
        id="load-more-button"
        data-current-page={currentPage}
        data-total-pages={totalPages}
        data-section={section || ""}
        class="btn btn-primary px-10 py-3 font-bold text-lg uppercase tracking-wide transition-all hover:scale-105 active:scale-95"
      >
        Ver Mais Postagens
      </button>
    </div>
  )
}

<script>
  function setupLoadMore() {
    const button = document.getElementById('load-more-button');
    if (!button || button.hasAttribute('data-initialized')) return;
    button.setAttribute('data-initialized', 'true');

    let currentPage = parseInt(button.getAttribute('data-current-page') || '1');
    const totalPages = parseInt(button.getAttribute('data-total-pages') || '1');
    const section = button.getAttribute('data-section') || '';

    button.addEventListener('click', async () => {
      button.setAttribute('disabled', 'true');
      button.innerText = 'Carregando...';

      const nextPage = currentPage + 1;
      const url = section ? `/${section}/page/${nextPage}` : `/page/${nextPage}`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Falha ao carregar mais postagens');

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Find the posts container in the current page
        const postsContainer = document.querySelector('#posts-container .grid');
        // Find the posts container in the fetched page
        const newPostsContainer = doc.querySelector('#posts-container .grid');

        if (postsContainer && newPostsContainer) {
          // Append all children (post items) from the new container to the old one
          // Filter out the first post if it's fluid/featured on subsequent pages?
          // Actually, on /page/X pages, fluid=false is used, so no featured post.
          const newPosts = Array.from(newPostsContainer.children);
          newPosts.forEach(post => {
            postsContainer.appendChild(post);
          });

          currentPage = nextPage;
          button.setAttribute('data-current-page', currentPage.toString());

          if (currentPage >= totalPages) {
            button.parentElement?.remove();
          } else {
            button.removeAttribute('disabled');
            button.innerText = 'Ver Mais Postagens';
          }
        }
      } catch (error) {
        console.error(error);
        button.innerText = 'Erro ao carregar. Tente novamente.';
        button.removeAttribute('disabled');
      }
    });
  }

  // Run on page load and after Astro view transitions
  setupLoadMore();
  document.addEventListener('astro:page-load', setupLoadMore);
</script>

